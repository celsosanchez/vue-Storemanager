<template>
  <div>
    <v-row>
      <v-col class="d-flex justify-center">
        <v-hover close-delay="189" open-delay="191" v-slot="{ hover }">
          <v-card :elevation="hover ? 12 : 2" min-width="400" class="mb-8">
            <v-card-title >
              Select User
            </v-card-title>
            <v-card-actions>
              <v-autocomplete
                v-model="autocomplete"
                :loading="loading"
                :items="possibleUsers"
                label="Email"
              ></v-autocomplete>
            </v-card-actions>
          </v-card>
        </v-hover>
      </v-col>
      <v-col class="d-flex justify-center">
        <v-hover close-delay="189" open-delay="191" v-slot="{ hover }">
          <v-card
            :elevation="hover ? 12 : 2"
            min-width="200"
            min-height="150"
            class="mb-8"
          >
            <v-card-title>
              Desired stock
            </v-card-title>
            <v-card-actions>
              <warehouse-dialog
                ref="warehouse"
                :activeUser="currentUser"
                :currentItems="currentItems"
              />
            </v-card-actions>
          </v-card>
        </v-hover>
      </v-col>
      <v-col class="d-flex justify-center">
        <v-hover close-delay="189" open-delay="191" v-slot="{ hover }">
          <v-card
            :elevation="hover ? 12 : 2"
            min-width="200"
            min-height="150"
            class="mb-8"
          >
            <v-card-title >
              Shopping List
            </v-card-title>
            <v-card-actions>
              <list-dialog :activeUser="currentUser" />
            </v-card-actions>
          </v-card>
        </v-hover>
      </v-col>
      <v-col class="d-flex justify-center">
        <v-hover close-delay="189" open-delay="191" v-slot="{ hover }">
          <v-card
            :elevation="hover ? 12 : 2"
            min-width="200"
            min-height="150"
            class="mb-8"
          >
            <v-card-title>
              Warning!
            </v-card-title>
            <v-card-actions>
              <expiration-warning :activeUser="currentUser"  :warningList="expiredWarning" />
            </v-card-actions>
          </v-card>
        </v-hover>
      </v-col>
      <v-col class="d-flex justify-center">
        <v-hover close-delay="189" open-delay="191" v-slot="{ hover }">
          <v-card
            :elevation="hover ? 12 : 2"
            min-width="200"
            min-height="150"
            class="mb-8"
          >
            <v-card-title>
              Buy from Producer
            </v-card-title>
            <v-card-actions>
              <buy-from-producer :activeUser="currentUser"  />
            </v-card-actions>
          </v-card>
        </v-hover>
      </v-col>
    </v-row>

    <ProductData
      v-if="currentUser"
      ref="productData"
      :url="`http://192.168.31.175:3000/products`"
      :location="this.currentUser"
      ><template v-slot:tableTitle>
        <h3>My Fridge</h3>
        <v-icon large class="pl-3" color="blue">mdi-fridge</v-icon>
      </template></ProductData
    >
  </div>
</template>
<script>
import axios from "axios";
import ProductData from "@/components/ProductData.vue";
import ListDialog from "@/components/ListDialog.vue";
import WarehouseDialog from "@/components/WarehouseDialog.vue";
import ExpirationWarning from '../components/ExpirationWarning.vue';
import BuyFromProducer from '../components/buyFromProducer.vue';

export default {
  name: "Consumer",
  components: {
    ProductData,
    ListDialog,
    WarehouseDialog,
    ExpirationWarning,
    BuyFromProducer,
  },
  data: () => ({
    // fridgeStock: ['2s'],
    expiredWarning: [],
    productDatafinishedLoad: false,
    chosenUser: null,
    autocomplete: null,
    elevation: 2,
    loading: false,
    dialog: false,
    selected: [],
    possibleUsers: [],
    singleSelect: false,
    snackbar: false,
    currentUser: null,
    snackbarText: "",
    currentItems: [],
    // activeUser: false,
  }),
  methods: {
    reload(){
            this.$refs.productData.getData()
    }
  },
  created() {
    axios.get(`http://192.168.31.175:3000/users`).then((res) => {
      // this.receivedNames = [];
      this.possibleUsers = [];
      res.data.found.forEach((el) => {
        this.possibleUsers.push(el.email);
      });
    });
    setTimeout(() => {
      this.elevation = 6;
    }, "2000");
  },
  
  computed: {},
  watch: {
    productDatafinishedLoad() {
      this.currentItems = this.$refs.productData.items;

      this.expiredWarning = [];
      this.currentItems.forEach((element) => {
        var expiration = new Date(element.expiration_datetime);
        element.expirationIn = Math.round((expiration - Date.now()) / 86400000);
        if (element.expirationIn < 3) {
          const soonExpires = {
            name: element.product_name,
            producer: element.brands,
            expirationOn: element.expirationIn,
            image_url: element.image_url,
          };
          this.expiredWarning.push(soonExpires);
        }
      });
    },
    autocomplete(value) {
      // this.activeUser = true
      this.currentUser = value;
      setTimeout(() => {
        this.$refs.productData.getData();
        axios.put(`http://192.168.31.175:3000/UpdateSLfromDS`,{
          user: this.currentUser
        });


        
      }, "1");
    },
    // $active(value){console.log(value)}
  },
};
</script>
<style></style>
